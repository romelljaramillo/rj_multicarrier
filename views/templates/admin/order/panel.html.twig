
{% set hasShipment = shipment is defined and shipment %}
{% set currentOrderId = orderId|default(0)|intCast %}
{% set mode = mode|default('form') %}
{% set isPreviewOnly = mode == 'preview' %}

{% for message in notifications.errors %}
	<div class="alert alert-danger" role="alert">{{ message }}</div>
{% endfor %}
{% for message in notifications.warning %}
	<div class="alert alert-warning" role="alert">{{ message }}</div>
{% endfor %}
{% for message in notifications.success %}
	<div class="alert alert-success" role="alert">{{ message }}</div>
{% endfor %}
{% for message in notifications.info %}
	<div class="alert alert-info" role="alert">{{ message }}</div>
{% endfor %}

<div class="row g-4" data-rj-order-panel-root>
	{% if not isPreviewOnly %}
	<div class="col-12 col-lg-7">
		<div class="card">
			<h3 class="card-header">{{ 'RJ Multi-carrier'|trans({}, 'Modules.RjMulticarrier.Admin') }}</h3>
			<div class="card-body">
				{% if hasShipment %}
					<div class="mb-4">
						<dl class="row mb-0">
							<dt class="col-sm-4">{{ 'Número de envío'|trans({}, 'Modules.RjMulticarrier.Admin') }}</dt>
							<dd class="col-sm-8">{{ shipment.shipmentNumber ?: '-' }}</dd>

							<dt class="col-sm-4">{{ 'Transportista'|trans({}, 'Modules.RjMulticarrier.Admin') }}</dt>
							<dd class="col-sm-8">{{ shipment.carrierShortName ?: '-' }}</dd>

							<dt class="col-sm-4">{{ 'Referencia pedido'|trans({}, 'Modules.RjMulticarrier.Admin') }}</dt>
							<dd class="col-sm-8">{{ shipment.orderReference ?: '-' }}</dd>
						</dl>

						{% if shipment.package is defined and shipment.package %}
							<h4 class="h6 mt-3">{{ 'Información del bulto'|trans({}, 'Modules.RjMulticarrier.Admin') }}</h4>
							<ul class="list-unstyled mb-3">
								<li><strong>{{ 'Cantidad'|trans({}, 'Modules.RjMulticarrier.Admin') }}:</strong> {{ shipment.package.quantity }}</li>
								<li><strong>{{ 'Peso total'|trans({}, 'Modules.RjMulticarrier.Admin') }}:</strong> {{ shipment.package.weight }}</li>
								{% if shipment.package.length is defined %}
									<li>
										<strong>{{ 'Dimensiones'|trans({}, 'Modules.RjMulticarrier.Admin') }}:</strong>
										{{ shipment.package.length ?: '-' }}
										x
										{{ shipment.package.width ?: '-' }}
										x
										{{ shipment.package.height ?: '-' }}
									</li>
								{% endif %}
								{% if shipment.package.cash_ondelivery is defined and shipment.package.cash_ondelivery %}
									<li><strong>{{ 'Contra reembolso'|trans({}, 'Modules.RjMulticarrier.Admin') }}:</strong> {{ shipment.package.cash_ondelivery }}</li>
								{% endif %}
								{% if shipment.package.message %}
									<li><strong>{{ 'Mensaje'|trans({}, 'Modules.RjMulticarrier.Admin') }}:</strong> {{ shipment.package.message }}</li>
								{% endif %}
								{% if shipment.package.hour_from or shipment.package.hour_until %}
									<li>
										<strong>{{ 'Horario'|trans({}, 'Modules.RjMulticarrier.Admin') }}:</strong>
										{{ shipment.package.hour_from ?: '--:--:--' }} → {{ shipment.package.hour_until ?: '--:--:--' }}
									</li>
								{% endif %}
								{% if shipment.package.retorno is not null %}
									{% set retornoLabels = {
										0: 'Sin retorno'|trans({}, 'Modules.RjMulticarrier.Admin'),
										1: 'Retorno obligatorio'|trans({}, 'Modules.RjMulticarrier.Admin'),
										2: 'Retorno opcional'|trans({}, 'Modules.RjMulticarrier.Admin')
									} %}
									<li><strong>{{ 'Retorno'|trans({}, 'Modules.RjMulticarrier.Admin') }}:</strong> {{ retornoLabels[shipment.package.retorno]|default(shipment.package.retorno) }}</li>
								{% endif %}
								{% if shipment.package.rcs is not null %}
									<li><strong>{{ 'Retorno copia sellada'|trans({}, 'Modules.RjMulticarrier.Admin') }}:</strong> {{ shipment.package.rcs ? 'Sí'|trans({}, 'Modules.RjMulticarrier.Admin') : 'No'|trans({}, 'Modules.RjMulticarrier.Admin') }}</li>
								{% endif %}
								{% if shipment.package.vsec %}
									<li><strong>{{ 'Valor asegurado'|trans({}, 'Modules.RjMulticarrier.Admin') }}:</strong> {{ shipment.package.vsec }}</li>
								{% endif %}
								{% if shipment.package.dorig %}
									<li><strong>{{ 'Documento de origen'|trans({}, 'Modules.RjMulticarrier.Admin') }}:</strong> {{ shipment.package.dorig }}</li>
								{% endif %}
							</ul>
						{% endif %}

						<div class="d-flex justify-content-between align-items-center mb-3">
							<h4 class="h6 mb-0">{{ 'Etiquetas'|trans({}, 'Modules.RjMulticarrier.Admin') }}</h4>
							{% set deleteShipmentAction = '#' %}
							{% if currentOrderId > 0 %}
								{% set deleteShipmentAction = (currentOrderId is defined and currentOrderId) ? path('admin_rj_multicarrier_order_delete_shipment', {'orderId': currentOrderId, 'shipmentId': shipment.id}) : '#' %}
							{% endif %}
							<form method="post" class="mb-0" action="{{ deleteShipmentAction }}">
								<input type="hidden" name="id_order" value="{{ currentOrderId }}" />
								<input type="hidden" name="id_shipment" value="{{ shipment.id }}" />
								<button type="submit" class="btn btn-outline-danger btn-sm">
									{{ 'Eliminar envío'|trans({}, 'Modules.RjMulticarrier.Admin') }}
								</button>
							</form>
						</div>

						{% if shipment.labels is not empty %}
							<table class="table table-sm">
								<thead>
									<tr>
										<th>{{ 'ID'|trans({}, 'Modules.RjMulticarrier.Admin') }}</th>
										<th>{{ 'Paquete'|trans({}, 'Modules.RjMulticarrier.Admin') }}</th>
										<th>{{ 'Seguimiento'|trans({}, 'Modules.RjMulticarrier.Admin') }}</th>
										<th>{{ 'Tipo'|trans({}, 'Modules.RjMulticarrier.Admin') }}</th>
										<th>{{ 'Impreso'|trans({}, 'Modules.RjMulticarrier.Admin') }}</th>
									</tr>
								</thead>
								<tbody>
									{% for label in shipment.labels %}
										<tr>
											<td>{{ label.id }}</td>
											<td>{{ label.package_id ?: '-' }}</td>
											<td>{{ label.tracker_code ?: '-' }}</td>
											<td>{{ label.label_type ?: '-' }}</td>
											<td>
												{% if label.printed %}
													<span class="badge bg-success">{{ 'Sí'|trans({}, 'Modules.RjMulticarrier.Admin') }}</span>
												{% else %}
													<span class="badge bg-secondary">{{ 'No'|trans({}, 'Modules.RjMulticarrier.Admin') }}</span>
												{% endif %}
											</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
						{% else %}
							<p class="text-muted mb-0">{{ 'No se han generado etiquetas para este envío.'|trans({}, 'Modules.RjMulticarrier.Admin') }}</p>
						{% endif %}
					</div>
				{% endif %}

				{% set upsertPackageAction = '#' %}
				{% if currentOrderId > 0 %}
					{% set upsertPackageAction = (currentOrderId is defined and currentOrderId) ? path('admin_rj_multicarrier_order_upsert_package', {'orderId': currentOrderId}) : '#' %}
				{% endif %}
				<form method="post" class="rj-multicarrier-admin-order" action="{{ upsertPackageAction }}">
					<input type="hidden" name="id_order" value="{{ currentOrderId }}" />
					<input type="hidden" name="id_info_shipment" value="{{ request_values.id_info_shipment|default(info_package.id_info_shipment|default('')) }}" />
					<input type="hidden" name="id_shipment" value="{{ request_values.id_shipment|default(info_shipment.id_shipment|default('')) }}" />
					<input type="hidden" name="id_reference_carrier" id="rj-reference-carrier" value="{{ request_values.id_reference_carrier|default(info_package.id_reference_carrier|default('')) }}" />

					<div class="row mb-3">
						<div class="col-md-6">
							<label class="form-label">{{ 'Compañía'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<select name="carrier_id" class="form-select form-control" id="rj-carrier-select">
								<option value="">{{ 'Selecciona compañía'|trans({}, 'Modules.RjMulticarrier.Admin') }}</option>
								{% set selectedCarrier = request_values.carrier_id|default(selected_carrier_id|default('')) %}
								{% for company in companies %}
									<option value="{{ company.id }}" {% if company.id == selectedCarrier %}selected{% endif %}>{{ company.name }}</option>
								{% endfor %}
							</select>
						</div>
						<div class="col-md-6">
							<label class="form-label">{{ 'Tipo de envío'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<select name="id_type_shipment" class="form-select form-control" id="rj-type-select">
								<option value="">{{ 'Selecciona tipo'|trans({}, 'Modules.RjMulticarrier.Admin') }}</option>
								{% set selectedType = request_values.id_type_shipment|default(selected_type_shipment_id|default('')) %}
								{% for type in type_shipments %}
									<option
										value="{{ type.id }}"
										data-carrier-id="{{ type.carrier_id }}"
										data-reference-carrier="{{ type.reference_carrier_id }}"
										{% if type.id == selectedType %}selected{% endif %}
									>
										{{ type.name }}
									</option>
								{% endfor %}
							</select>
						</div>
					</div>

					<div class="row mb-3">
						<div class="col-md-2">
							<label class="form-label">{{ 'Cantidad'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<input type="number" name="rj_quantity" value="{{ request_values.rj_quantity|default(info_package.quantity|default(1)) }}" class="form-control" min="1"/>
						</div>
						<div class="col-md-2">
							<label class="form-label">{{ 'Peso'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<input type="text" name="rj_weight" value="{{ request_values.rj_weight|default(info_package.weight|default(0)) }}" class="form-control"/>
						</div>
						<div class="col-md-2">
							<label class="form-label">{{ 'Largo'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<input type="text" name="rj_length" value="{{ request_values.rj_length|default(info_package.length|default('')) }}" class="form-control"/>
						</div>
						<div class="col-md-2">
							<label class="form-label">{{ 'Ancho'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<input type="text" name="rj_width" value="{{ request_values.rj_width|default(info_package.width|default('')) }}" class="form-control"/>
						</div>
						<div class="col-md-2">
							<label class="form-label">{{ 'Alto'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<input type="text" name="rj_height" value="{{ request_values.rj_height|default(info_package.height|default('')) }}" class="form-control"/>
						</div>
						<div class="col-md-2">
							<label class="form-label">{{ 'Valor asegurado'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<input type="text" name="rj_vsec" value="{{ request_values.rj_vsec|default(info_package.vsec|default('')) }}" class="form-control"/>
						</div>
					</div>

					<div class="row mb-3">
						<div class="col-md-3">
							<label class="form-label">{{ 'Contra reembolso'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<div class="input-group mb-3">
								<div class="input-group-text">
									<input type="checkbox" name="rj_contrareembolso" id="rj_contrareembolso" value="1"
										{% if request_values.rj_cash_ondelivery is defined and request_values.rj_cash_ondelivery %}checked{% elseif info_package.cash_ondelivery is defined and info_package.cash_ondelivery|default(0) > 0 %}checked{% endif %} />
								</div>
								<input type="text" id="rj_cash_ondelivery" name="rj_cash_ondelivery" value="{{ request_values.rj_cash_ondelivery|default(info_package.cash_ondelivery|default('')) }}" class="form-control"/>
							</div>
						</div>
						<div class="col-md-3">
							<label class="form-label">{{ 'Hora desde'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<input type="time" name="rj_hour_from" value="{{ request_values.rj_hour_from|default(info_package.hour_from|default('')) }}" class="form-control"/>
						</div>
						<div class="col-md-3">
							<label class="form-label">{{ 'Hora hasta'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<input type="time" name="rj_hour_until" value="{{ request_values.rj_hour_until|default(info_package.hour_until|default('')) }}" class="form-control"/>
						</div>
						<div class="col-md-3">
							<label class="form-label">{{ 'Documento de origen'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							<input type="text" name="rj_dorig" value="{{ request_values.rj_dorig|default(info_package.dorig|default('')) }}" class="form-control"/>
						</div>
					</div>

					<div class="row mb-3">
						<div class="col-md-4">
							<label class="form-label">{{ 'Retorno'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
							{% set retornoValue = request_values.rj_retorno|default(info_package.retorno|default(0)) %}
							<select name="rj_retorno" class="form-select form-control">
								<option value="0" {% if retornoValue == 0 %}selected{% endif %}>{{ 'Sin retorno'|trans({}, 'Modules.RjMulticarrier.Admin') }}</option>
								<option value="1" {% if retornoValue == 1 %}selected{% endif %}>{{ 'Retorno obligatorio'|trans({}, 'Modules.RjMulticarrier.Admin') }}</option>
								<option value="2" {% if retornoValue == 2 %}selected{% endif %}>{{ 'Retorno opcional'|trans({}, 'Modules.RjMulticarrier.Admin') }}</option>
							</select>
						</div>
						<div class="col-md-4 d-flex align-items-end">
							<div class="form-check">
								<input class="form-check-input" type="checkbox" name="rj_rcs" id="rj_rcs_checkbox" {% if request_values.rj_rcs is defined %}checked{% elseif info_package.rcs|default(0) %}checked{% endif %}>
								<label class="form-check-label" for="rj_rcs_checkbox">
									{{ 'Retorno copia sellada'|trans({}, 'Modules.RjMulticarrier.Admin') }}
								</label>
							</div>
						</div>
					</div>

					<div class="mb-3">
						<label class="form-label">{{ 'Mensaje'|trans({}, 'Modules.RjMulticarrier.Admin') }}</label>
						<textarea name="rj_message" class="form-control" rows="2">{{ request_values.rj_message|default(info_package.message|default('')) }}</textarea>
					</div>

					{% if config_extra_info.company is not empty or config_extra_info.type_shipment is not empty %}
						<div class="mb-4">
							<h5 class="h6">{{ 'Configuraciones guardadas'|trans({}, 'Modules.RjMulticarrier.Admin') }}</h5>
							{% if config_extra_info.company is not empty %}
								<p class="text-muted mb-1">{{ 'Compañía'|trans({}, 'Modules.RjMulticarrier.Admin') }}</p>
								<ul class="list-unstyled small mb-2">
									{% for key, value in config_extra_info.company %}
										<li><strong>{{ key }}</strong>: {{ value is not empty ? value : '-' }}</li>
									{% endfor %}
								</ul>
							{% endif %}
							{% if config_extra_info.type_shipment is not empty %}
								<p class="text-muted mb-1">{{ 'Tipo de envío'|trans({}, 'Modules.RjMulticarrier.Admin') }}</p>
								<ul class="list-unstyled small mb-0">
									{% for key, value in config_extra_info.type_shipment %}
										<li><strong>{{ key }}</strong>: {{ value is not empty ? value : '-' }}</li>
									{% endfor %}
								</ul>
							{% endif %}
						</div>
					{% endif %}

					<div class="d-flex flex-column flex-md-row gap-2 align-items-md-center">
						<div class="btn-group" role="group">
							<button type="submit" class="btn btn-secondary">
								{{ 'Guardar bulto'|trans({}, 'Modules.RjMulticarrier.Admin') }}
							</button>
						</div>
						{# Generate shipment: separate form that posts to new route when info package exists #}
						{% if info_package.id_info_shipment is defined and info_package.id_info_shipment %}
							{% set generateShipmentAction = '#' %}
							{% if currentOrderId > 0 %}
								{% set generateShipmentAction = (currentOrderId is defined and currentOrderId) ? path('admin_rj_multicarrier_order_generate_shipment', {'orderId': currentOrderId, 'infoPackageId': info_package.id_info_shipment}) : '#' %}
							{% endif %}
							<form method="post" action="{{ generateShipmentAction }}" class="ms-2">
								<button type="submit" class="btn btn-primary" {% if hasShipment %}disabled{% endif %}>
									{{ 'Generar envío'|trans({}, 'Modules.RjMulticarrier.Admin') }}
								</button>
							</form>
						{% else %}
							<button type="button" class="btn btn-primary" disabled>
								{{ 'Generar envío'|trans({}, 'Modules.RjMulticarrier.Admin') }}
							</button>
						{% endif %}
						{% if hasShipment %}
							<span class="small text-muted">{{ 'Elimina el envío actual para poder generar uno nuevo.'|trans({}, 'Modules.RjMulticarrier.Admin') }}</span>
						{% endif %}
					</div>
				</form>

				{% if hasShipment %}
					<p class="text-muted small mt-3 mb-0">
						{{ 'Puedes actualizar los datos del bulto y guardarlos; para generar un nuevo envío elimina el existente primero.'|trans({}, 'Modules.RjMulticarrier.Admin') }}
					</p>
				{% endif %}
			</div>
		</div>
	</div>
	{% endif %}

	{% include '@Modules/rj_multicarrier/views/templates/admin/order/label_preview.html.twig' %}
</div>
<script>
(function (global) {
	function resolveScope(rootCandidate) {
		if (rootCandidate && typeof rootCandidate.querySelector === 'function') {
			return rootCandidate;
		}

		if (global.document) {
			return global.document;
		}

		return null;
	}

	function initOrderPanel(rootCandidate) {
		const scope = resolveScope(rootCandidate);
		if (!scope) {
			return;
		}

		const panelRoot = scope.querySelector('[data-rj-order-panel-root]');

		if (!panelRoot || panelRoot.dataset.rjPanelReady === '1') {
			return;
		}

		panelRoot.dataset.rjPanelReady = '1';

		const carrierSelect = panelRoot.querySelector('#rj-carrier-select');
		const typeSelect = panelRoot.querySelector('#rj-type-select');
		const referenceInput = panelRoot.querySelector('#rj-reference-carrier');

		const updateReferenceCarrier = () => {
			if (!typeSelect || !referenceInput) {
				return;
			}

			const selectedOption = typeSelect.options[typeSelect.selectedIndex];
			if (selectedOption && selectedOption.dataset.referenceCarrier) {
				referenceInput.value = selectedOption.dataset.referenceCarrier;
			} else if (!selectedOption || !selectedOption.value) {
				referenceInput.value = '';
			}
		};

		const updateTypeOptions = () => {
			if (!carrierSelect || !typeSelect) {
				return;
			}

			const carrierId = carrierSelect.value;
			let hasSelected = false;

			Array.from(typeSelect.options).forEach((option) => {
				if (!option.value) {
					return;
				}

				const optionCarrier = option.dataset.carrierId || '';
				const matchesCarrier = !carrierId || carrierId === optionCarrier;

				option.hidden = !matchesCarrier;
				if (!matchesCarrier && option.selected) {
					option.selected = false;
				}

				if (matchesCarrier && option.selected) {
					hasSelected = true;
				}
			});

			if (!hasSelected) {
				typeSelect.selectedIndex = 0;
			}

			updateReferenceCarrier();
		};

		if (carrierSelect) {
			carrierSelect.addEventListener('change', updateTypeOptions);
		}

		if (typeSelect) {
			typeSelect.addEventListener('change', updateReferenceCarrier);
		}

		updateTypeOptions();
		updateReferenceCarrier();

		const contrareembolsoCheckbox = panelRoot.querySelector('#rj_contrareembolso');
		const cashOnDeliveryInput = panelRoot.querySelector('#rj_cash_ondelivery');
		const defaultCod = '{{ info_package.cash_ondelivery|default('')|e('js') }}';

		function parseNumberFromText(text) {
			if (!text) {
				return '';
			}

			const cleaned = text.replace(/[^0-9,\.\-]/g, '').trim();
			if (!cleaned) {
				return '';
			}

			return cleaned.replace(/,/g, '.');
		}

		function tryReadOrderTotalFromPage() {
			const selectors = ['.order-total', '#order_total', '#orderTotal', '.total_paid', '.order-price', '.total-value', '.order-amount'];
			for (const sel of selectors) {
				const el = global.document ? global.document.querySelector(sel) : null;
				if (el && el.textContent) {
					const num = parseNumberFromText(el.textContent);
					if (num) {
						return num;
					}
				}
			}

			return '';
		}

		function getPriceOrder() {
			if (!contrareembolsoCheckbox || !cashOnDeliveryInput) {
				return;
			}

			if (!contrareembolsoCheckbox.checked) {
				cashOnDeliveryInput.value = '';
				return;
			}

			if (defaultCod !== '' && defaultCod !== '0') {
				cashOnDeliveryInput.value = defaultCod;
				return;
			}

			const fromPage = tryReadOrderTotalFromPage();
			if (fromPage) {
				cashOnDeliveryInput.value = fromPage;
				return;
			}

			cashOnDeliveryInput.value = '';
		}

		if (contrareembolsoCheckbox) {
			contrareembolsoCheckbox.addEventListener('change', getPriceOrder);
		}

		getPriceOrder();
	}

	global.rjMulticarrier = global.rjMulticarrier || {};
	global.rjMulticarrier.initOrderPanel = initOrderPanel;

	if (global.document) {
		if (global.document.readyState === 'loading') {
			global.document.addEventListener('DOMContentLoaded', () => initOrderPanel(global.document));
		} else {
			initOrderPanel(global.document);
		}
	}
})(typeof window !== 'undefined' ? window : this);
</script>
